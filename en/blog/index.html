<!DOCTYPE html>
<html prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a web site for chizuwota">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>chizuwota</title>
<link href="https://fonts.googleapis.com/css?family=Bitter:400,400i,700" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS (en)" hreflang="en" href="../rss.xml">
<link rel="alternate" type="application/rss+xml" title="RSS (ja)" hreflang="ja" href="../../rss.xml">
<link rel="canonical" href="https://chizuwota.net/en/blog/">
<!--[if lt IE 9]><script src="../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-26157323-5"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-26157323-5');
</script>
</head>
<body>

	<a href="#page-content" class="sr-only sr-only-focusable">
		Skip to main content
	</a>

	

    <section id="header"><a href="../../">
			<div class="logo">
					<div id="nologoimage">
						chizuwota
					</div>
    		</div>
			</a>
    </section><section id="socialNav"><!-- Navigation Menu - on top on small screens, down the left on larger --><div class="navlinks">
			<a href="../../">
				<div id="titleauth">
    					chizuwota<br> by PEmugi
				</div>
			</a>

            <!-- Navigation links (hidden by default) -->
			<div id="navmenuitems">
				            <a href="../../index.html" title="Home">
                <span class="menuitemtext">Home</span>
                <span class="menuitemicon"><i class="fa fa-home"></i></span>
            </a>
            <a href="../../projects/" title="Projects">
                <span class="menuitemtext">Projects</span>
                <span class="menuitemicon"><i class="fas fa-globe"></i></span>
            </a>
            <a href="../../blog/" title="Blog">
                <span class="menuitemtext">Blog</span>
                <span class="menuitemicon"><i class="fa fa-book"></i></span>
            </a>
            <a href="../../archive.html" title="Blog Archives">
                <span class="menuitemtext">Blog Archives</span>
                <span class="menuitemicon"><i class="fa fa-folder-open"></i></span>
            </a>
            <a href="../../categories/index.html" title="Blog Tags">
                <span class="menuitemtext">Blog Tags</span>
                <span class="menuitemicon"><i class="fa fa-tags"></i></span>
            </a>
            <a href="https://twitter.com/PEmugi2" title="">
                <span class="menuitemtext"></span>
                <span class="menuitemicon"><i class="fab fa-twitter"></i></span>
            </a>
            <a href="https://www.linkedin.com/in/shimpei-matsuura-26974441/" title="">
                <span class="menuitemtext"></span>
                <span class="menuitemicon"><i class="fab fa-linkedin"></i></span>
            </a>
            <a href="https://github.com/PEmugi" title="">
                <span class="menuitemtext"></span>
                <span class="menuitemicon"><i class="fab fa-github"></i></span>
            </a>
            <a href="../../rss.xml" title="">
                <span class="menuitemtext"></span>
                <span class="menuitemicon"><i class="fa fa-rss"></i></span>
            </a>
    
    

			</div>

            <!-- "Hamburger menu" / "Bar icon" to toggle the navigation links -->
			<a href="javascript:void(0);" id="hamburger" class="icon" onclick="toggleNav()">
				<i class="fa fa-bars">
				</i>
			</a>
		</div>

	</section><section class="page-content"><div class="content" rel="main">
    
    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="wsl/wsl2-vdisk-compression/" class="u-url">WSL2 の仮想ディスクを圧縮する</a></h1>

        
        <div class="metadata">
            <p class="dateline"><a href="wsl/wsl2-vdisk-compression/" rel="bookmark"><i class="fa fa-clock"></i> <time class="published dt-published" datetime="2021-08-26T01:33:36+09:00" title="2021-08-26 01:33">2021-08-26 01:33</time></a></p>

                <p class="commentline"><i class="fa fa-comment"></i>             <a href="wsl/wsl2-vdisk-compression/#disqus_thread" data-disqus-identifier="cache/posts/wsl/wsl2-vdisk-compression.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>WSL2 使っていると、気が付いたらハードディスクの容量を圧迫していたなんてことがよくあります。</p>
<p>仮想マシン上で大きなファイルを作成したり、作業をしているうちに当然仮想ディスクのサイズは大きくなりますが、仮想マシン上でファイルを削除し他場合、仮想ディスク内で <code>df -h</code> などすれば容量が減っていることを確認できるのですが、実は仮想ディスクのファイルそのもののサイズは解放されません。</p>
<p>ここでは、肥大化した仮想ディスクのファイルのサイズを解放する方法を紹介します。</p>
<h3 id="_1">目次</h3>
<div class="toc">
<ul>
<li><a href="wsl/wsl2-vdisk-compression/#_1">目次</a></li>
<li>
<a href="wsl/wsl2-vdisk-compression/#_2">仮想ディスクの確認</a><ul>
<li><a href="wsl/wsl2-vdisk-compression/#_3">私の環境の圧縮前のサイズはこんな感じ</a></li>
</ul>
</li>
<li>
<a href="wsl/wsl2-vdisk-compression/#_4">仮想ディスクの圧縮</a><ul>
<li>
<a href="wsl/wsl2-vdisk-compression/#1-wsl">1. WSL の停止</a><ul>
<li><a href="wsl/wsl2-vdisk-compression/#_5">仮想マシンのシャットダウン</a></li>
<li><a href="wsl/wsl2-vdisk-compression/#wsl">WSL サービスの停止</a></li>
</ul>
</li>
<li><a href="wsl/wsl2-vdisk-compression/#2-diskpart">2. DISKPART で圧縮</a></li>
<li><a href="wsl/wsl2-vdisk-compression/#3-wsl">3. WSL サービスの再開</a></li>
</ul>
</li>
<li><a href="wsl/wsl2-vdisk-compression/#_6">まとめ</a></li>
</ul>
</div>
<h3 id="_2">仮想ディスクの確認</h3>
<p>WSL2 の仮想マシンのファイルは Microsoft Store からインストールされた Ubuntu であれば以下のパスにあります。</p>
<p><code>C:\Users\{USERNAME}\AppData\Local\Packages\CanonicalGroupLimited.UbuntuonWindows_xxxxxxxxx\LocalState\ext4.vhdx</code></p>
<p>.vhdx は Windows の Hyper-V の仮想ディスクフォーマットなのかしら...  </p>
<div class="admonition tips">
<p class="admonition-title">Tips: Docker Desktop for Windows の場合</p>
<p>Docker Desktop の WSL2 バックエンドでも WSL2 の仮想マシンを使いますが、むしろ Docker 仮想マシンの肥大化のがやばいかもしれません。<br>
イメージビルドの際のキャッシュとかイメージそのもので容量を食べますし。  </p>
<p>Docker の WSL2 のディスクイメージは以下にありました。</p>
<p><code>C:\Users\{USERNAME}\AppData\Local\Docker\wsl</code></p>
</div>
<h4 id="_3">私の環境の圧縮前のサイズはこんな感じ</h4>
<p>3.6GB ぐらいでしょうか。<br><img alt="" src="../../images/posts/wsl/wsl2-vdisk-compression-1.png"></p>
<p><code>df -h</code> の結果は以下なので実際のディスク消費量と 1GB ぐらい差がありそうです。</p>
<p><img alt="" src="../../images/posts/wsl/wsl2-vdisk-compression-2.png"></p>
<h3 id="_4">仮想ディスクの圧縮</h3>
<h4 id="1-wsl">1. WSL の停止</h4>
<p>WSL を止めます。<br>
仮想マシンを停止した後、念のため WSL のサービスも落とします。</p>
<h5 id="_5">仮想マシンのシャットダウン</h5>
<p>PowerShell か Command prompt で以下を実行</p>
<pre class="code literal-block"><span class="n">wsl</span> <span class="p">-</span><span class="n">-shutdown</span>
</pre>
<h5 id="wsl">WSL サービスの停止</h5>
<p>PowerShell か Command prompt を管理者として実行し、以下コマンドを実行</p>
<pre class="code literal-block">net stop LxssManager
LxssManager サービスを停止中です.
LxssManager サービスは正常に停止されました。
</pre>
<h4 id="2-diskpart">2. DISKPART で圧縮</h4>
<p>PowerShell や Command prompt から以下コマンドで DISKPART を起動</p>
<pre class="code literal-block">diskpart
</pre>
<p>起動したら以下コマンドで仮想ディスクを選択します</p>
<pre class="code literal-block">DISKPART&gt; <span class="k">select</span> vdisk <span class="nv">file</span><span class="o">=</span><span class="s2">"C:\Users\pemugi\AppData\Local\Packages\CanonicalGroupLimited.UbuntuonWindows_xxxxxxxxx\LocalState\ext4.vhdx"</span>

DiskPart により、仮想ディスク ファイルが選択されました。
</pre>
<p>そして圧縮します</p>
<pre class="code literal-block">DISKPART&gt; compact vdisk

  <span class="m">100</span>% 完了しました
DISKPART&gt; <span class="nb">exit</span>
</pre>
<h4 id="3-wsl">3. WSL サービスの再開</h4>
<p>PowerShell か Command prompt を管理者として実行し、以下コマンドを実行</p>
<pre class="code literal-block">net start LxssManager
</pre>
<h3 id="_6">まとめ</h3>
<p>DISKPART を使って vhdx を圧縮する方法を紹介しました。<br>
Webエンジニアやバックエンドエンジニアの開発環境は、ここしばらく Mac が優勢ですが、今後 Windows + WSL2 な人も増えてきそうかな？</p>
<p>WSL や Docker Desktop for Windows (WSL2) を使ってて、仮想ディスクの容量に困ったら試してみてくださいませ～。</p>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="welcome-to-chizuwota/" class="u-url">Welcom to chizuwota!!</a></h1>

        
        <div class="metadata">
            <p class="dateline"><a href="welcome-to-chizuwota/" rel="bookmark"><i class="fa fa-clock"></i> <time class="published dt-published" datetime="2021-08-22T22:58:43+09:00" title="2021-08-22 22:58">2021-08-22 22:58</time></a></p>

                <p class="commentline"><i class="fa fa-comment"></i>             <a href="welcome-to-chizuwota/#disqus_thread" data-disqus-identifier="cache/posts/welcome-to-chizuwota.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<h3 id="chizuwota">chizuwota という屋号で開業</h3>
<p>1 年ぐらい前から細々と副業するために開業して、個人事業主として活動してました。</p>
<p>屋号は chizuwota です。</p>
<p>地図オタクとよべるほどの人間ではないけれど、それ以外に取り柄もないし。</p>
<p>あと chizuwota.net というドメインは学生時代の2006年から使っていて愛着があったのでそのまま屋号として採用。</p>
<h3 id="_1">情報発信で恩返し</h3>
<p>2008 年に株式会社サイバーマップジャパン(-&gt; マピオン -&gt; One Compass に社名変更)に入社してからずっと空間情報を扱うのデータエンジニアやバックエンドエンジニアとして業界にかかわってきました。</p>
<p>平凡なエンジニアなんですが、15年も同じ領域でやっていれば多少の蓄積はあるものです。
いままで情報発信はあまりしてこなかったのですが、40歳目前ですが遅すぎることもないかなと思い、なけなしの知識を発信していければと。</p>
<p>そして、空間情報関連の技術がさらにいろんな業界に広がっていくことに超微力ながら貢献できたらなと思ってます。</p>
<p>もちろん、個人事業の集客も兼ねていますけどね！</p>
<h3 id="nikola">静的サイトジェネレータ Nikola で作ってるよ</h3>
<p>このサイトは <a href="https://getnikola.com/" target="_blank">Nikola</a>  という Python で書かれた静的サイトジェネレータで作っています。</p>
<p>以下採用理由</p>
<ul>
<li>Markdown で書ける</li>
<li>開発が活発(2021-08-21 現在)</li>
<li>設定がシンプル</li>
<li>github pages へのデプロイがコマンド一発</li>
<li>github actions も簡単</li>
</ul>
</div>
    </div>
    </article>
</div>

               <script>var disqus_shortname="chizuwota";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><footer id="footer"><p>Contents © 2021         <a href="mailto:PEmugi@chizuwota.net">PEmugi</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
	</section><script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>

    moment.locale("en");
    fancydates(2, "YYYY-MM-DD HH:mm");

	</script><!-- end fancy dates --><script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});

	</script><script src="../../assets/js/ToggleNav.js">
	</script>
</body>
</html>
